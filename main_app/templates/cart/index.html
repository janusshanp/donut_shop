{% extends 'base.html' %} {% block content %}

{% if checkout %}
	<h2>Your Cart</h2>
	<a href="{% url 'shop' %}">Continue Shopping</a>
{% elif order %}
	<h2>Order Complete</h2>
	<p>Your Order No. is {{order.order_no}}</p>
{% elif confirm  %}
	<h2>Review Page</h2>
	<a href="{% url 'shop' %}">Continue Shopping</a>
	<a href="{% url 'cart' %}">Edit Cart</a>
{% endif %}

<table>
	<tr>
		<th>Product</th>
		<th></th>
		<th>Price</th>
		<th>Quantity</th>
		<th>Total</th>
	</tr>
	{% for item in items %}
	<tr class ="items" id="{{item.id}}">
		<td><img src="{{item.donut.image}}" /></td>
		<td>{{item.donut.name}}</td>
		<td id = "price">{{item.donut.price}}</td>
		<td>
			{% if checkout %}
				<div class="quantity">
					<button id="minus">-</button>
					<input id="{{item.donut.id}}" class="cart-q" type="number" value={{item.quantity}}>
					<button id="plus">+</button>
				</div>
			{% else %}
				<input id="{{item.donut.id}}" class="cart-q" type="number" value={{item.quantity}} disabled>
			{% endif %}				
		</td>
		<td id="total"></td>
	{% if checkout %}
		<td><a href = "{% url 'delete_donut' item.donut.id %}" class="btn">Delete</a></td>
	{% endif %}
	</tr>
	{% endfor %}
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td>Subtotal</td>
		<td id="total-cart"></td>
	</tr>

</table>

{% if confirm %}
	<form action="{% url 'cart_complete'%}">
		<button class="btn">Complete</button>
	</form>
{% elif checkout %}
	<form action="{% url 'payment'%}" method="post">
		{% csrf_token %}
		<input name="date" type="datetime-local" id="id_date" required>
		<p>Notes</p>
		<input name="notes" type="text" placeholder="Tell us what you need!">
		<button class="btn">Checkout</button>
	</form>
{% endif %}

<script>
	{% comment %} var dateEl = document.getElementById('id_date');
	M.Datepicker.init(dateEl, {
		defaultDate: new Date(),
		setDefaultDate: true,
		autoClose: true
	});  {% endcomment %}
	
	plusButton = document.querySelectorAll('#plus');
	minusButton = document.querySelectorAll('#minus');
	inputBox = document.querySelectorAll('.cart-q');
	totalBox = document.querySelectorAll('#total');
	priceBox = document.querySelectorAll('#price');
	items = document.querySelectorAll('.items');
	totalcart = document.getElementById('total-cart')

	for (let i=0; i < totalBox.length; i++){
		totalBox[i].textContent = (inputBox[i].value * parseFloat(priceBox[i].textContent)).toFixed(2)
	}

	updateTotal()
	
	for (let i=0; i < plusButton.length; i++){
		plusButton[i].addEventListener("click",function(){
			inputBox[i].value = parseInt(inputBox[i].value) + 1
			totalBox[i].textContent = (inputBox[i].value * parseFloat(priceBox[i].textContent)).toFixed(2)
			sendQuantity(inputBox[i].value, inputBox[i].id, items[i].id)
			updateTotal()
		})
		minusButton[i].addEventListener("click",function(){
			if (inputBox[i].value > 1){
				inputBox[i].value = parseInt(inputBox[i].value) - 1
				totalBox[i].textContent = (inputBox[i].value * parseFloat(priceBox[i].textContent)).toFixed(2)
				sendQuantity(inputBox[i].value, inputBox[i].id,items[i].id)
				updateTotal()
			}
		})
	}
	
	function updateTotal(){
		total = 0
		for (let i=0; i < totalBox.length; i++){
			total += parseFloat(totalBox[i].textContent)
		}
		totalcart.textContent = total.toFixed(2)
	}
	
	const BASE_URL = 'http://localhost:8000/cart/quantity/'

	async function sendQuantity (amount, donutId, itemId) {
		url = (`${BASE_URL}${donutId}/${itemId}/${amount}/`)
		quantity = await fetch(url).then(console.log("hi"))
	}
	
</script>

{% endblock %}
